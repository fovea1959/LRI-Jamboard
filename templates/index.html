{% extends 'base.html' %}

{% block title %}Public Scoreboard{% endblock %}

{% block head %}
<style>
#contextMenu {
  position: absolute;
  display:none;
}

// see https://stackoverflow.com/a/27704409 for why we include the table id

#team-table .x-lri-t-weighed {
  background-color: #ffffff;
}

#team-table .x-lri-t-inspected {
  background-color: #80ff80;
}

#team-table .x-lri-t- {
  background-color: #808080;
}

#team-table .x-lri-blank {
  background-color: #808080;
}

#page-table .x-lri-blank {
  background-color: #808080;
}
</style>
{% endblock %}

{% block body %}
<!-- https://stackoverflow.com/a/68817428 -->
<div class="container p-0 m-0">
  <table class="table vh-100 vw-100" id="page-table">
    <tr>
      <td class="p-0 m-0 col-9">
        <table id="team-table" class="table table-bordered vh-100" style="table-layout: fixed;">
        {% for row in team_rows %}
          <tr>
          {% for g in row %}
            {% set team=g.team %}
            {% if team is none %}
              <td class="x-lri-blank"></td>
            {% else %}
              <td class="x-lri-t- cm" id="t-{{team.team_number}}">
                <div class="h1">{{ team.team_number }}</div>
                <div class="h6">{{ team.team_name }}</div>
                <div class="h6">{{ team.city }}</div>
                <div id="t-{{team.team_number}}-status"></div>
              </td>
            {% endif %}
          {% endfor %}
          </tr>
        {% endfor %}
        </table>
      </td>
      <td class="col-3 x-lri-blank">
        <div id="status"></div>
        <div id="inspectors">
        {% for i in inspectors %}
          <div class="x-lri-i-available">
              {{ i.name }}: <span id="i-{{ i.id }}-status"></span>
          </div>
        {% endfor %}
        </div>
      </td>
    </tr>
  </table>
</div>
<div id="contextMenu" class="dropdown clearfix">
  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu" style="display:block;position:static;margin-bottom:5px;">
    <li><a tabindex="-1" href="#">Action</a></li>
    <li><a tabindex="-1" href="#">Another action</a></li>
    <li><a tabindex="-1" href="#">Something else here</a></li>
    <li class="divider"></li>
    <li><a tabindex="-1" href="#">Separated link</a></li>
  </ul>
</div>
<!-- context menu: https://stackoverflow.com/a/31305343 -->
<script src="/static/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
$(function() {

  var $contextMenu = $("#contextMenu");

  $("body").on("click", "table .cm", function(e) {
    $contextMenu.css({
      display: "block",
      left: e.pageX,
      top: e.pageY
    });
    return false;
  });

  $contextMenu.on("click", "a", function() {
     $contextMenu.hide();
  });

});

// https://stackoverflow.com/a/53190845 slightly modified the regexp
function removeClassStartingWith(node, begin) {
  node.removeClass (function (index, className) {
    return (className.match ( new RegExp("\\b"+begin+"\\S*", "g") ) || []).join(' ');
  });
}

$(document).ready(function() {
  // Connect to the Socket.IO server.
  // The connection URL has the following format, relative to the current page:
  //     http[s]://<domain>:<port>[/<namespace>]
  var socket = io();

  // Event handler for new connections.
  // The callback function is invoked when a connection with the
  // server is established.
  socket.on('connect', function() {
      socket.emit('lri_event', {data: 'LRI page connected!'});
      socket.emit('send_teams', {});
      socket.emit('send_inspectors', {});
  });

  socket.on('team', function(msg, cb) {
      // $('#log').append('<br>' + $('<div/>').text(JSON.stringify(msg)).html());
      var team_number = msg.team_number.toString();

      $('#t-' + team_number + '-status').text(msg.status);

      removeClassStartingWith($('#t-' + team_number), 'x-lri-t-');
      $('#t-' + team_number).addClass('x-lri-t-' + msg.status.toLowerCase());
      if (cb)
          cb();
  });

  socket.on('inspector', function(msg, cb) {
      var inspector_id = msg.id.toString();

      $('#i-' + inspector_id + '-status').text(msg.status_text);

      if (cb)
          cb();
  });
});

</script>
{% endblock %}
